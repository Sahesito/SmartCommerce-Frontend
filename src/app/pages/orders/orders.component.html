<p-toast />
<p-confirmDialog />

<div class="orders-page">

    <!-- Header -->
    <div class="page-header">
        <div>
            <h1>Pedidos</h1>
            <p>{{ isAdmin() ? 'Gestiona todos los pedidos' : 'Mis pedidos' }}</p>
        </div>
    </div>

    <!-- Búsqueda -->
    <div class="search-bar">
        <input pInputText [(ngModel)]="searchTerm" placeholder="Buscar por ID, usuario o estado..."
            class="search-input" />
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <p-table [value]="filteredOrders" [loading]="loading" [paginator]="true" [rows]="10"
            [rowsPerPageOptions]="[5, 10, 20]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '60rem'}">
            <ng-template pTemplate="header">
                <tr>
                    <th>#</th>
                    <th>Usuario</th>
                    <th>Total</th>
                    <th>Ciudad</th>
                    <th>Pago</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-order>
                <tr>
                    <td><strong>#{{ order.id }}</strong></td>
                    <td>Usuario #{{ order.userId }}</td>
                    <td><strong>S/ {{ order.totalAmount | number:'1.2-2' }}</strong></td>
                    <td>{{ order.shippingCity }}</td>
                    <td>
                        <span class="payment-method">{{ order.paymentMethod }}</span>
                    </td>
                    <td>
                        <p-tag [value]="getStatusLabel(order.status)" [severity]="getStatusSeverity(order.status)" />
                    </td>
                    <td>{{ order.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="action-buttons">
                            <p-button icon="pi pi-eye" [text]="true" size="small" pTooltip="Ver detalle"
                                (onClick)="openDetail(order)" />
                            @if (canUpdateStatus()) {
                            <p-button icon="pi pi-refresh" [text]="true" severity="info" size="small"
                                pTooltip="Cambiar estado" (onClick)="openStatusDialog(order)" />
                            }
                            @if (canCancel(order)) {
                            <p-button icon="pi pi-times" [text]="true" severity="warn" size="small" pTooltip="Cancelar"
                                (onClick)="confirmCancel(order)" />
                            }
                            @if (isAdmin()) {
                            <p-button icon="pi pi-trash" [text]="true" severity="danger" size="small"
                                pTooltip="Eliminar" (onClick)="confirmDelete(order)" />
                            }
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="empty-message">
                        No se encontraron pedidos
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

</div>

<!-- Dialog Detalle -->
<p-dialog header="Detalle del Pedido" [(visible)]="detailVisible" [style]="{width: '580px'}" [modal]="true">
    @if (selectedOrder) {
    <div class="order-detail">

        <div class="detail-grid">
            <div class="detail-item">
                <span class="detail-label">Pedido</span>
                <span class="detail-value">#{{ selectedOrder.id }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Estado</span>
                <p-tag [value]="getStatusLabel(selectedOrder.status)"
                    [severity]="getStatusSeverity(selectedOrder.status)" />
            </div>
            <div class="detail-item">
                <span class="detail-label">Usuario</span>
                <span class="detail-value">#{{ selectedOrder.userId }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Método de pago</span>
                <span class="detail-value">{{ selectedOrder.paymentMethod }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Dirección</span>
                <span class="detail-value">{{ selectedOrder.shippingAddress }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Ciudad / País</span>
                <span class="detail-value">
                    {{ selectedOrder.shippingCity }}, {{ selectedOrder.shippingCountry }}
                </span>
            </div>
            @if (selectedOrder.notes) {
            <div class="detail-item full">
                <span class="detail-label">Notas</span>
                <span class="detail-value">{{ selectedOrder.notes }}</span>
            </div>
            }
        </div>

        <p-divider />

        <h3>Productos</h3>
        <div class="order-items">
            @for (item of selectedOrder.items; track item.id) {
            <div class="order-item">
                <div class="order-item-info">
                    <span class="item-name">{{ item.productName }}</span>
                    <span class="item-qty">x{{ item.quantity }}</span>
                </div>
                <div class="order-item-price">
                    <span class="unit-price">S/ {{ item.unitPrice | number:'1.2-2' }} c/u</span>
                    <strong>S/ {{ item.subtotal | number:'1.2-2' }}</strong>
                </div>
            </div>
            }
        </div>

        <p-divider />

        <div class="order-total">
            <span>Total</span>
            <strong>S/ {{ selectedOrder.totalAmount | number:'1.2-2' }}</strong>
        </div>

    </div>
    }
</p-dialog>

<!-- Dialog Cambiar Estado -->
<p-dialog header="Cambiar Estado del Pedido" [(visible)]="statusDialogVisible"
    [style]="{width: '420px', minHeight: '280px'}" [modal]="true" [resizable]="false">
    @if (selectedOrder) {
    <div class="status-form">
        <div class="current-status">
            <span>Estado actual:</span>
            <p-tag [value]="getStatusLabel(selectedOrder.status)"
                [severity]="getStatusSeverity(selectedOrder.status)" />
        </div>

        <div class="field">
            <label>Nuevo estado</label>
            <p-select [(ngModel)]="statusRequest.status" [options]="statusOptions" optionLabel="label"
                optionValue="value" styleClass="w-full" appendTo="body" placeholder="Selecciona un estado" />
        </div>
    </div>
    }

    <ng-template pTemplate="footer">
        <p-button label="Cancelar" severity="secondary" [outlined]="true" (onClick)="statusDialogVisible = false" />
        <p-button label="Actualizar" icon="pi pi-check" [loading]="saving" (onClick)="updateStatus()" />
    </ng-template>
</p-dialog>